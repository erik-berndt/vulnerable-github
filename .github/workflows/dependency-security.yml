name: Dependency Security Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Läuft jeden Tag um 6 Uhr morgens
    - cron: '0 6 * * *'
  workflow_dispatch: # Ermöglicht manuelles Ausführen

# Permissions für GITHUB_TOKEN explizit setzen
#permissions:
#  contents: write
#  issues: write
#  pull-requests: write

jobs:
  security-audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Run npm audit
        run: |
          echo "## Security Audit Results" >> audit-results.md
          echo "\`\`\`" >> audit-results.md
          pnpm audit --audit-level moderate >> audit-results.md || echo "Vulnerabilities found"
          echo "\`\`\`" >> audit-results.md

      - name: Check for vulnerabilities
        id: vuln-check
        run: |
          if pnpm audit --audit-level high --json > audit.json; then
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
          else
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "High severity vulnerabilities found!"
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-results
          path: |
            audit-results.md
            audit.json

      - name: Create Issue for vulnerabilities
        if: steps.vuln-check.outputs.has_vulnerabilities == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let auditResults = '';
            try {
              auditResults = fs.readFileSync('audit-results.md', 'utf8');
            } catch (error) {
              auditResults = 'Could not read audit results';
            }
            
            const title = `Security Vulnerabilities Detected - ${new Date().toISOString().split('T')[0]}`;
            const body = `# Security Alert
                  Automatische Überprüfung hat Sicherheitslücken in den Dependencies gefunden.
                  
                  ## Details:
                  ${auditResults}
                  
                  ## Nächste Schritte:
                  1. Überprüfe die gefundenen Vulnerabilities
                  2. Aktualisiere die betroffenen Packages
                  3. Führe Tests durch
                  4. Schließe diese Issue nach der Behebung
                  
                  **Automatisch erstellt am:** ${new Date().toISOString()}`;
                  
              try {
              // Prüfe ob bereits ein ähnliches Issue existiert
              const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['security', 'dependencies']
            });
              
              const hasOpenSecurityIssue = existingIssues.data.some(issue =>
              issue.title.includes('Security Vulnerabilities Detected')
              );
              
              if (!hasOpenSecurityIssue) {
              const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['security', 'dependencies', 'high-priority']
            });
            console.log(`Issue created: ${issue.data.html_url}`);
            } else {
              console.log('Security issue already exists, skipping creation');
            }
            } catch (error) {
              console.error('Error creating issue:', error.message);
            }

  dependency-update:
      runs-on: ubuntu-latest
      if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'

      steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            token: ${{ secrets.GITHUB_TOKEN }}

        - name: Setup pnpm
          uses: pnpm/action-setup@v4
          with:
            version: 8

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '20'
            cache: 'pnpm'

        - name: Install dependencies
          run: pnpm install --no-frozen-lockfile

        - name: Check for outdated packages and create PR
          uses: actions/github-script@v7
          with:
            github-token: ${{ secrets.GITHUB_TOKEN }}
            script: |
              const { execSync } = require('child_process');
              const fs = require('fs');

              try {
                console.log('Checking for outdated packages...');

                // Konfiguriere Git
                execSync('git config user.name "GitHub Actions"');
                execSync('git config user.email "actions@github.com"');

                // Erstelle einen neuen Branch
                const branchName = `auto-dependency-updates-${Date.now()}`;
                const defaultBranch = context.payload.repository.default_branch || 'main';

                console.log(`Creating branch: ${branchName}`);
                execSync(`git checkout -b ${branchName}`);

                // Führe Updates durch
                console.log('Updating dependencies...');
                try {
                  execSync('pnpm update --latest', { stdio: 'inherit' });
                } catch (updateError) {
                  console.log('Update completed with warnings (normal for dependency updates)');
                }

                // Prüfe ob es Änderungen gibt
                const gitStatus = execSync('git status --porcelain', { encoding: 'utf8' });

                if (!gitStatus.trim()) {
                  console.log('No changes to commit - all dependencies are up to date');
                  return;
                }

                console.log('Changes detected:');
                console.log(gitStatus);

                // Committe die Änderungen
                execSync('git add package.json pnpm-lock.yaml');
                execSync('git commit -m "chore(deps): update dependencies\n\nAuto-generated dependency updates"');
                execSync(`git push origin ${branchName}`);

                // Erstelle Pull Request
                const prTitle = `Automated Dependency Updates - ${new Date().toISOString().split('T')[0]}`;
                const prBody = `
              # Automated Dependency Updates

              Diese PR enthält automatische Updates für veraltete Dependencies.

              ## Änderungen:
              \`\`\`
              ${gitStatus}
              \`\`\`

              ## Überprüfung notwendig:
              - [ ] Tests laufen erfolgreich
              - [ ] Keine Breaking Changes
              - [ ] Security Updates sind enthalten

              **Automatisch erstellt am:** ${new Date().toISOString()}

              > **Wichtig**: Bitte überprüfe die Änderungen vor dem Merge!`;

                const pullRequest = await github.rest.pulls.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: prTitle,
                  head: branchName,
                  base: defaultBranch,
                  body: prBody
                });

                console.log(`Pull Request created: ${pullRequest.data.html_url}`);

                // Weise PR zu
                await github.rest.issues.addAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pullRequest.data.number,
                  assignees: ['erik-berndt']
                });

                // Füge Labels hinzu
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pullRequest.data.number,
                  labels: ['dependencies', 'automated', 'maintenance']
                });

                } catch (error) {
                console.error('Error in dependency update process:', error.message);
                console.error(error.stack);
                }